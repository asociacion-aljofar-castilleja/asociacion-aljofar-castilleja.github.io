---
import { getEntry } from "astro:content";

type Lang = "es" | "en";
type Img = { src: string; alt: string };

interface Props {
  lang: Lang;
  title?: string;
  text?: string;
  images?: Img[];
  badges?: string[];
  address?: string;
  mapsUrl?: string;
  mapEmbedUrl?: string;
  layout?: "grid" | "carousel";
  sectionId?: string;
  logoHeight?: number; // ignorado en este comp
}

const {
  lang,
  title,
  text,
  images = [],
  badges = [],
  address,
  mapsUrl,
  mapEmbedUrl,
  layout = "grid",
  sectionId,
} = Astro.props as Props;

// i18n (colección 'ui', ids: Headquarters/es|en)
const idMap = { es: "headquarters/es", en: "headquarters/en" } as const;
type HQI18n = {
  title?: string;
  ariaSection?: string;
  badgesTitle?: string;
  viewOnMaps?: string;
  galleryLabel?: string;
  carouselLabel?: string;
};
const entry = await getEntry({ collection: "ui", id: idMap[lang] });
const I = (entry?.data ?? {}) as HQI18n;

const sectionTitle = title ?? I.title ?? (lang === "en" ? "Our headquarters" : "Nuestra sede");
const id = sectionId ?? (lang === "en" ? "headquarters" : "sede");

const hasMap = Boolean(mapEmbedUrl);
const hasImages = images.length > 0;
---

<section id={id} class="hq-section py-5 bg-body-tertiary" aria-label={I.ariaSection ?? sectionTitle} data-module="Headquarters">
  <div class="container">
    <div class="row g-4 align-items-start">
      <!-- Texto + badges + dirección -->
      <div class={`col-12 ${hasImages || hasMap ? 'col-lg-5' : 'col-lg-8'}`}>
        <h2 class="mb-3">{sectionTitle}</h2>
        {text && <p class="lead">{text}</p>}

        {badges.length > 0 && (
          <div class="mt-3">
            <div class="fw-semibold mb-2">{I.badgesTitle ?? (lang === "en" ? "Accessibility features" : "Medidas de accesibilidad")}</div>
            <ul class="list-unstyled d-flex flex-wrap gap-2">
              {badges.map((b) => <li class="badge rounded-pill text-bg-success">{b}</li>)}
            </ul>
          </div>
        )}

        {(address || mapsUrl) && (
          <div class="mt-3">
            {address && <div class="small text-body-secondary">{address}</div>}
            {mapsUrl && (
              <a class="btn btn-outline-secondary btn-sm mt-2" href={mapsUrl} target="_blank" rel="noopener">
                {I.viewOnMaps ?? (lang === "en" ? "View on maps" : "Ver en el mapa")}
              </a>
            )}
          </div>
        )}
      </div>

      <!-- Medios: galería/carrusel + mapa -->
      <div class={`col-12 ${hasImages || hasMap ? 'col-lg-7' : 'col-lg-4'}`}>
        {hasImages && layout === "grid" && (
          <div aria-label={I.galleryLabel ?? (lang === "en" ? "Headquarters image gallery" : "Galería de imágenes de la sede")}>
            <div class="row g-3">
              {images.slice(0, 6).map((img) => (
                <div class="col-6">
                  <figure class="ratio ratio-4x3 rounded overflow-hidden shadow-sm">
                    <img
                      src={img.src}
                      alt={img.alt}
                      class="w-100 h-100 hq-object-cover"
                      loading="lazy"
                      decoding="async"
                    />
                  </figure>
                </div>
              ))}
            </div>
          </div>
        )}

        {hasImages && layout === "carousel" && (
          <div class="hq-carousel carousel slide shadow-sm rounded overflow-hidden"
               aria-label={I.carouselLabel ?? (lang === "en" ? "Headquarters image carousel" : "Carrusel de imágenes de la sede")}
               data-bs-ride="carousel" data-bs-interval="5000">
            <div class="carousel-inner">
              {images.map((img, i) => (
                <div class={`carousel-item ${i===0 ? 'active' : ''}`}>
                  <div class="ratio ratio-16x9">
                    <img
                      src={img.src}
                      class="d-block w-100 h-100 hq-object-cover"
                      alt={img.alt}
                      loading={i>0 ? "lazy" : "eager"}
                      decoding="async"
                    />
                  </div>
                </div>
              ))}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-slide="prev" aria-label="Prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-slide="next" aria-label="Next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
            </button>
          </div>
        )}

        {hasMap && (
          <div class={`mt-3 ${hasImages ? '' : 'mt-lg-0'}`}>
            <div class="ratio ratio-16x9 rounded overflow-hidden shadow-sm">
              <iframe
                src={mapEmbedUrl}
                style="border:0"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                title={sectionTitle}
              ></iframe>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</section>
