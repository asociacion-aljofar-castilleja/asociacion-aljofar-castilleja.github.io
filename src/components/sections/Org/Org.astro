---
import { getEntry } from "astro:content";

type Lang = "es" | "en";
type RoleItem = string | { role?: string; person?: string };

interface Props {
  lang: Lang;
  roles: RoleItem[];
  layout?: "list" | "grid";
  titleOverride?: string;
  columns?: string;
  accent?: "primary" | "success" | "info" | "warning";
}

const {
  lang,
  roles = [],
  layout = "list",
  titleOverride,
  columns = "row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3",
  accent = "primary",
} = Astro.props as Props;

const idMap = { es: "org/es", en: "org/en" } as const;
type I18n = { title?: string; ariaSection?: string; ariaItem?: string; empty?: string };

const entry = await getEntry({ collection: "ui", id: idMap[lang] });
const I = (entry?.data ?? {}) as I18n;

const title = titleOverride ?? I.title ?? (lang === "en" ? "Organization" : "Organigrama");
const ariaSection = I.ariaSection ?? title;
const emptyText = I.empty ?? (lang === "en" ? "No roles defined yet." : "Aún no hay roles definidos.");

const normalize = (r: RoleItem) => (typeof r === "string" ? { role: r, person: undefined } : { role: r.role ?? "", person: r.person });
const items = (Array.isArray(roles) ? roles : []).map(normalize);

const ariaItem = (role?: string, person?: string) => {
  const tpl = I.ariaItem ?? (lang === "en" ? "{{role}} — {{person}}" : "{{role}} — {{person}}");
  return tpl
    .replace("{{role}}", role || (lang === "en" ? "Role" : "Rol"))
    .replace("{{person}}", person || (lang === "en" ? "Unassigned" : "Por asignar"));
};

const initials = (text?: string) => (text ? text.split(/\s+/).map(w => w[0]).slice(0,2).join("").toUpperCase() : "–");
---

<section class="org-section" aria-label={ariaSection} data-module="OrgList">
  <div class="d-flex align-items-center gap-2 mb-3">
    <h2 class="section-title mb-0">{title}</h2>
  </div>

  {items.length === 0 ? (
    <p class="text-muted">{emptyText}</p>
  ) : layout === "grid" ? (
    <div class={columns}>
      {items.map((it) => (
        <div class="col d-flex">
          <article class={`org-card card border-0 shadow-sm w-100 border-top border-4 border-${accent}`} aria-label={ariaItem(it.role, it.person)}>
            <div class="card-body d-flex align-items-center gap-3">
              <div class={`avatar avatar-${accent}`} aria-hidden="true">{initials(it.person ?? it.role)}</div>
              <div>
                <strong class="org-role d-block">{it.role}</strong>
                <span class="org-person d-block">{it.person ?? (lang === "en" ? "Unassigned" : "Por asignar")}</span>
              </div>
            </div>
          </article>
        </div>
      ))}
    </div>
  ) : (
    <ul class="org-list list-unstyled m-0">
      {items.map((it) => (
        <li class="org-list__item py-2" aria-label={ariaItem(it.role, it.person)}>
          <span class="org-role">{it.role}</span>
          <span class="org-sep mx-2">·</span>
          <span class="org-person">{it.person ?? (lang === "en" ? "Unassigned" : "Por asignar")}</span>
        </li>
      ))}
    </ul>
  )}
</section>

